

EJERCICIO3:
-- AL AÃ‘ADIR UN PARTIDO, MIRAR AMBOS EQUIPOS DISINTOS
-- SI NO LO SON LANZAR EXCEPCION
-- EN CASO CONTRARIO
	--COMPROBAR ASOCIACION, NIVELES ETC


	
/*	HECHO CON UN PROCEDURE PARA VER SI FUNCIONA EL CODIGO*/

create or replace procedure ejercicio3julio is

   cursor cequipos is 
    select * from jugar;

    asociacioneq1 equipo.asociacion%type;
    asociacioneq2 equipo.asociacion%type;
    niveleq1 equipo.nivel%type;
    niveleq2 equipo.nivel%type;

    equipo_duplicado exception;
    
begin 

  for creg in cequipos loop

    select nivel into niveleq1 from equipo where equipo.codigo = creg.equipo1;
    select nivel into niveleq2 from equipo where equipo.codigo = creg.equipo2;
    select equipo.asociacion into asociacioneq1 from equipo where equipo.codigo = creg.equipo1;
    select equipo.asociacion into asociacioneq2 from equipo where equipo.codigo = creg.equipo2;

    if creg.equipo1 = creg.equipo2 then
        raise equipo_duplicado;
    
    elsif asociacioneq1 <> asociacioneq2 then
    
         if niveleq1 > niveleq2 then
            update equipo set nivel = niveleq2;
            dbms_output.put_line('el equipo ' || creg.equipo1 || ' a pasado ha tener el nivel de ' || niveleq2);
         
         elsif niveleq2 > niveleq1 then
             update equipo set nivel = niveleq1;
             dbms_output.put_line('el equipo ' || creg.equipo2 || ' a pasado ha tener el nivel de ' || niveleq1);
         end if;
    
    end if;

  end loop;
  
exception
    when equipo_duplicado then
    escribir('Equipo duplicado :D');
    
end;


/* HECHO CON TRIGGER COMO PIDE EL EJERCICIO */
/*
	EN EL PROCEDURE VA TODO BIEN
	PERO EL TRIGGER NO SE LANZA AL INSERTAR NI IDEA DE PORQUE
	PREGUNTAR A JOSE ESTA MIERDA QUE LO HAGA EN CLASE

*/

create or replace trigger ejercicio3RECU 
before insert or update of nivel on equipo
for each row
declare
   cursor cequipos is 
    select * from jugar;

    asociacioneq1 equipo.asociacion%type;
    asociacioneq2 equipo.asociacion%type;
    
    niveleq1 equipo.nivel%type;
    niveleq2 equipo.nivel%type;

    equipo_duplicado exception;

begin 

   for creg in cequipos loop

    select nivel into niveleq1 from equipo where equipo.codigo = creg.equipo1;
    select nivel into niveleq2 from equipo where equipo.codigo = creg.equipo2;
    
    select equipo.asociacion into asociacioneq1 from equipo where equipo.codigo = creg.equipo1;
    select equipo.asociacion into asociacioneq2 from equipo where equipo.codigo = creg.equipo2;

    if creg.equipo1 = creg.equipo2 then
        raise_application_error(20000, 'Equipos con mismo nombre, cancelar operacion');
    
    elsif asociacioneq1 <> asociacioneq2 then
    
         if niveleq1 > niveleq2 then
            update equipo set nivel = niveleq2;
            dbms_output.put_line('el equipo ' || creg.equipo1 || ' a pasado ha tener el nivel de ' || niveleq2);
         
         elsif niveleq2 > niveleq1 then
             update equipo set nivel = niveleq1;
             dbms_output.put_line('el equipo ' || creg.equipo2 || ' a pasado ha tener el nivel de ' || niveleq1);
         end if;
    
    end if;

  end loop;

end;