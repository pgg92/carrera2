create or replace trigger ejercicio2julio
before insert or update on asociacion
for each row
declare

    equiposasociados number(3);

begin

    equiposasociados := 0;

    select count(*) into equiposasociados 
    from asociacion, equipo
    where equipo.asociacion = :new.asociacion
    and asociacion.codigo = :new.asociacion;

    if equiposasociados > 0 then
        if :new.nivel > 5 then
            update asociacion 
            set destacado = ((select destacados from asociacion 
                            where asociacion.codigo = :new.codigo) + 1)
            where asociacion.codigo = :new.codigo;

        end if;
    end if;

end;

create or replace trigger ejercicio3julio
before insert or update of nivel on equipo
for each row
declare

    cursor tablaJugar is select * from jugar;
    
    nivele1 equipo.nivel%type;
    nivele2 equipo.nivel%type;
    codigoe1 equipo.codigo%type;
    codigoe2 equipo.codigo%type;
    asociacione2 equipo.asociacion%type;
    asociacione1 equipo.asociacion%type;

begin


    for reg in tablaJugar loop
        
        codigoe1 := reg.equipo1;
        codigoe2 := reg.equipo2;
        select nivel into nivele1 from equipo where codigo = reg.equipo1;
        select nivel into nivele2 from equipo where codigo = reg.equipo2;
        
        if reg.equipo1 = reg.equipo2 then
            raise_application_error
            (-2000, 'El equipo' || reg.equipo1 || 'no se puede enfrentar' 
            || 'a si mismo');
        end if;
        
    end loop;
    
    select asociacion into asociacione1 from equipo where codigo = codigoe1;
    select asociacion into asociacione2 from equipo where codigo = codigoe2;
    
    if asociacione2 <> asociacione1 then
    
        if nivele1 > nivele1 then
            update equipo set nivel = nivele1 where nivel = nivele2;
            escribir('El equipo' || codigoe2 || 'ha pasado a tener nivel'
            || nivele1);
        else
            escribir('El equipo' || codigoe1 || 'ha pasado a tener nivel'
            || nivele2);
            update equipo set nivel = nivele1 where nivel = nivele1;
        end if;
    end if;
    
end;


create or replace trigger ejercicio7julio
before insert or update of asociacion on equipo
for each row
declare

    cursor listadoEntrenadores is select * from entrenador;
    asociacionEquipo asociacion.codigo%type;
    entrenadoresAsociados number(3);

    cursor cosasnazis is
    select * from entrenador
    where entrenador.asociacion = asociacionEquipo and
    entrenador.nivel = (select nivel from equipo where codigo = :new.codigo);


begin

    -- al menos un entrenador pertenece a la asociacion

    entrenadoresAsociados := 0;
    select asociacion into asociacionEquipo from equipo where codigo = :new.codigo;

    for reg in listadoEntrenadores loop
        if reg.asociacion = asociacionEquipo then
            entrenadoresAsociados := entrenadoresAsociados + 1;
        end if;
    end loop;

    if entrenadoresAsociados = 0 then
        escribir('La asociacion' || asociacionEquipo || 'no tiene entrenadores');
    end if;

    -- si tiene comprobar entrenadores mismo nivel que el equipoy despues
    -- insertarlo en la tabla responsables
    for reg in cosasnazis loop
        insert into responsables(codigo) values reg.codigo;
    end loop;

end;
